<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Noel Touch Mobile</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: black;
    font-family: 'Times New Roman', serif;
}
#canvas-container {
    width: 100vw;
    height: 100vh;
}
#ui {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    z-index: 10;
}
h1 {
    color: #fceea7;
    font-size: 36px;
    letter-spacing: 5px;
    margin-bottom: 15px;
}
.upload-btn {
    background: rgba(0,0,0,0.6);
    border: 1px solid #d4af37;
    color: #d4af37;
    padding: 10px 20px;
    font-size: 11px;
    letter-spacing: 2px;
}
input { display:none; }
.hint {
    color: rgba(212,175,55,0.6);
    font-size: 10px;
    margin-top: 8px;
}
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<div id="ui">
    <h1>MERRY CHRISTMAS</h1>
    <label class="upload-btn">
        Thêm ảnh
        <input type="file" id="file" accept="image/*" multiple>
    </label>
    <div class="hint">Vuốt xoay · Chạm 2 lần đổi chế độ</div>
</div>

<div id="canvas-container"></div>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

const isMobile = true;

const CONFIG = {
    count: 600,
    dust: 800
};

let scene, camera, renderer, composer;
let group = new THREE.Group();
let particles = [];
let mode = 'TREE';

const clock = new THREE.Clock();

init();
animate();

/* ---------- INIT ---------- */
function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);

    camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 55;

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(1);
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(
        new THREE.Vector2(innerWidth, innerHeight),
        0.25, 0.4, 0.85
    ));

    scene.add(group);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const light = new THREE.PointLight(0xffaa55, 2);
    light.position.set(0,10,10);
    scene.add(light);

    createTree();
    createDust();

    window.addEventListener('resize', onResize);
    setupTouch();
    document.getElementById('file').addEventListener('change', addPhotos);
}

/* ---------- TREE ---------- */
function createTree() {
    const geo = new THREE.SphereGeometry(0.45, 24, 24);
    const mat = new THREE.MeshStandardMaterial({
        color: 0xffd966,
        metalness: 1,
        roughness: 0.2
    });

    for(let i=0;i<CONFIG.count;i++){
        const mesh = new THREE.Mesh(geo, mat);
        const t = Math.random();
        const y = t*22 - 11;
        const r = (1-t)*7;
        const a = t*40*Math.PI;

        mesh.position.set(
            Math.cos(a)*r,
            y,
            Math.sin(a)*r
        );
        group.add(mesh);
        particles.push(mesh);
    }
}

/* ---------- DUST ---------- */
function createDust() {
    const geo = new THREE.TetrahedronGeometry(0.08);
    const mat = new THREE.MeshBasicMaterial({ color:0xffeebb });

    for(let i=0;i<CONFIG.dust;i++){
        const m = new THREE.Mesh(geo, mat);
        m.position.set(
            (Math.random()-0.5)*40,
            (Math.random()-0.5)*40,
            (Math.random()-0.5)*40
        );
        group.add(m);
        particles.push(m);
    }
}

/* ---------- UPLOAD ---------- */
function addPhotos(e){
    [...e.target.files].forEach(file=>{
        const reader = new FileReader();
        reader.onload = ev=>{
            const tex = new THREE.TextureLoader().load(ev.target.result);
            const geo = new THREE.PlaneGeometry(1.2,1.2);
            const mat = new THREE.MeshBasicMaterial({ map:tex });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(
                (Math.random()-0.5)*10,
                (Math.random()-0.5)*10,
                (Math.random()-0.5)*10
            );
            group.add(mesh);
        };
        reader.readAsDataURL(file);
    });
}

/* ---------- TOUCH ---------- */
let lastTap = 0;
let startX = 0, startY = 0;

function setupTouch(){
    window.addEventListener('touchstart', e=>{
        const t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;

        const now = Date.now();
        if(now - lastTap < 300){
            mode = mode === 'TREE' ? 'SCATTER' : 'TREE';
        }
        lastTap = now;
    });

    window.addEventListener('touchmove', e=>{
        const t = e.touches[0];
        const dx = (t.clientX - startX) * 0.005;
        const dy = (t.clientY - startY) * 0.005;
        group.rotation.y += dx;
        group.rotation.x += dy;
    });
}

/* ---------- LOOP ---------- */
function animate(){
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    if(mode === 'TREE') group.rotation.y += dt*0.3;
    composer.render();
}

/* ---------- RESIZE ---------- */
function onResize(){
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
    composer.setSize(innerWidth, innerHeight);
}
</script>
</body>
</html>
